const btoa = require('btoa');
const qs = require('querystring');
const request = require('request-promise-native');
const uuid = require('uuid');

module.exports = class SpotifyApiClient {
  constructor(authToken, handleError) {
    this.authToken = authToken;
    this.handleError = handleError || console.error;
  }

  static getAuthorizeUrl(state) {
    const query = {
      client_id: process.env.SPOTIFY_CLIENT_ID,
      response_type: 'code',
      redirect_uri: process.env.SPOTIFY_REDIRECT_URI,
      scope: 'playlist-read-collaborative playlist-read-private playlist-modify-private playlist-modify-public',
      show_dialog: true,
      state,
    };

    return `https://accounts.spotify.com/authorize?${qs.stringify(query)}`
  }

  static async authorize(code) {
    const token = btoa(`${process.env.SPOTIFY_CLIENT_ID}:${process.env.SPOTIFY_CLIENT_SECRET}`);

    return request({
      method: 'POST',
      uri: 'https://accounts.spotify.com/api/token',
      headers: {
        Accept: '*/*',
        Authorization: `Basic ${token}`,
        'Content-Type': 'application/x-www-form-urlencoded',
        'User-Agent': 'npmn/0.0.1',
      },
      body: qs.stringify({
        grant_type: 'authorization_code',
        code,
        redirect_uri: process.env.SPOTIFY_REDIRECT_URI,
      }),
      json: true,
    });
  }

  makeAuthenticatedRequest(method, uri, payload = {}) {
    const requestOptions = {
      method,
      uri: `https://api.spotify.com/v1/${uri}`,
      headers: {
        Authorization: `Bearer ${this.authToken}`,
      },
      json: true,
    };

    if (method === 'PATCH' || method === 'POST' || method === 'PUT') {
      requestOptions.body = payload;
    } else if (method === 'GET') {
      requestOptions.qs = payload;
    }

    return request(requestOptions);
  }

  async addAlbumToPlaylist(album, playlist) {
    try {
      const { items } = await this.makeAuthenticatedRequest('GET', `albums/${album}/tracks`);

      return this.makeAuthenticatedRequest('POST', `playlists/${playlist}/tracks`, {
        uris: items.map(({ uri }) => uri),
      });
    } catch (error) {
      this.handleError('Failed to add to playlist', error);
    }
  }

  createPlaylist(user, name) {
    try {
      return this.makeAuthenticatedRequest('POST', `users/${user}/playlists`, {
        name,
        description: 'Automatically generated by nmpm',
        public: false,
      });
    } catch (error) {
      this.handleError('Failed to create new playlist', error);
    }
  }

  getUser() {
    try {
      return this.makeAuthenticatedRequest('GET', 'me');
    } catch (error) {
      this.handleError('Failed to get user information', error);
    }
  }

  async search(q, type) {
    try {
      const response = await this.makeAuthenticatedRequest('GET', 'search', { q, type });

      return response.albums.items;
    } catch (error) {
      this.handleError('Failed search', error);
    }
  }

  setAuthToken(authToken) {
    this.authToken = authToken;

    return this;
  }
}
